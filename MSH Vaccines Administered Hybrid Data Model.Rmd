---
title: "MSHS COVID-19 Vaccination Summary"
output: html_document
---
  
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

```{r Install and load packages}
# Code for creating summary of COVID vaccine administration -----------------

#Install and load necessary packages --------------------
# install.packages("readxl")
# install.packages("writexl")
# install.packages("ggplot2")
# install.packages("lubridate")
# install.packages("dplyr")
# install.packages("reshape2")
# install.packages("svDialogs")
# install.packages("stringr")
# install.packages("formattable")
# install.packages("kableExtra")
# install.packages("ggpubr")
# install.packages("zipcodeR")
# install.packages("tidyr")

#Analysis for weekend discharge tracking
library(readxl)
library(writexl)
library(ggplot2)
library(lubridate)
library(dplyr)
library(reshape2)
library(svDialogs)
library(stringr)
library(formattable)
library(scales)
library(ggpubr)
library(reshape2)
library(knitr)
library(kableExtra)
library(rmarkdown)
library(zipcodeR)
library(tidyr)
library(purrr)
library(janitor)
library(DT)
```

```{r Set directory, import reference data, and repository, include = FALSE}
# Set working directory and select raw data ----------------------------
rm(list = ls())

# Determine path for working directory
if ("Presidents" %in% list.files("J://")) {
  user_directory <- paste0("J:/Presidents/HSPI-PM/",
                           "Operations Analytics and Optimization/Projects/",
                           "System Operations/COVID Vaccine")
} else {
  user_directory <- paste0("J:/deans/Presidents/HSPI-PM/",
                           "Operations Analytics and Optimization/Projects/",
                           "System Operations/COVID Vaccine")
}

# Set path for file selection
user_path <- paste0(user_directory, "\\*.*")

# Determine whether or not to update an existing repo
update_repo <- FALSE

# Import reference data for site and pod mappings
# Import reference data for site and pod mappings
dept_mappings <- read_excel(paste0(
  user_directory,
  "/Hybrid Repo Sched & Admin Data",
  "/Hybrid Reporting Dept Mapping 2022-08-08.xlsx"),
  sheet = "Hybrid Dept Mapping")

vax_admin_data_mappings <- dept_mappings %>%
  select(-Department) %>%
  unique()

# Store today's date
today <- Sys.Date()

# Site order
all_sites <- c("MSB",
               "MSBI",
               "MSH",
               "MSM",
               "MSQ",
               "MSW",
               "MSVD",
               "Network")

# Vaccine types
vax_types <- c("Adult (12 yo +)", "Peds (5-11 yo)", "Peds (6 mo - 4 yo)")

# Dept grouper
dept_group <- c("Hospital POD", "MSHS Practice", "MSHS Inpatient & ED")
```

```{r Import existing repo and append as needed}
# Import schedule repository daily summary for 2020 and 2021
sched_repo_summary <- readRDS(
  paste0(user_directory,
         "/Hybrid Repo Sched & Admin Data",
         "/Sched Arr Visits 2020-2021 Daily Summary 2022-08-12.RDS"))

# Import vaccine administration repository daily summary for Jan-Jun 2022
vax_admin_repo_summary <- readRDS(
  paste0(user_directory,
         "/Hybrid Repo Sched & Admin Data",
         "/Admin Immune Jan-Jun2022 Daily Summary 2022-08-12.RDS"))

hybrid_repo <- rbind(sched_repo_summary,
                     vax_admin_repo_summary)

# # Needs to be updated once we start receiving weekly reports
# if (update_repo) {
# 
#   # Determine date range of reports to add to repository
#   if (sched_repo_update_date == today - 1) {
#     new_report_dates <- today - 1
#   } else {
#     new_report_dates <- seq.Date(sched_repo_update_date, today - 1, by = 1)
#   }
# 
#   new_report_dates_pattern <- format(new_report_dates, "%Y%m%d")
# 
#   # Find list of reports
#   file_list_vacc_sched <- list.files(
#     path = paste0(user_directory,
#                   "/Epic Auto Report Sched All Status"),
#     pattern = paste0("^(Covid_vaccine_all_status_ZipCode_)",
#                      new_report_dates_pattern,
#                      ".*.csv",
#                      collapse = "|"))
# 
#   # Import reports and add a column with report name and report date
#   import_new_reports <- map_df(
#     file_list_vacc_sched,
#     .f = function(x){
#       sched_data <- read.csv(
#         paste0(user_directory,
#                "/Epic Auto Report Sched All Status/",
#                x),
#         stringsAsFactors = FALSE,
#         check.names = FALSE) %>%
#         mutate(Filename = x,
#                ReportDate = as.Date(str_extract(x, "[0-9]{8}"),
#                                     "%Y%m%d"),
#                DOB = as.Date(DOB, format = "%m/%d/%Y"),
#                `Made Date` = as.Date(`Made Date`, format = "%m/%d/%y"),
#                Date = as.Date(Date, "%m/%d/%Y"),
#                `Appt Time` = as.POSIXct(paste("1899-12-31 ", `Appt Time`),
#                                         tz = "", format = "%Y-%m-%d %H:%M %p"),
#                `ZIP Code` = substr(`ZIP Code`, 2, nchar(`ZIP Code`)),
#                `PATIENTS LIFE NUMBER OR ORACLE NUMBER` = as.character(
#                  `PATIENTS LIFE NUMBER OR ORACLE NUMBER`))
#     }
#   )
# 
#   # Filter schedule data from new reports to only keep appointments in latest reports
#   sched_data_new_reports <- import_new_reports %>%
#     group_by(Date) %>%
#     slice_max(ReportDate) %>%
#     mutate(Filename = NULL,
#            ReportDate = NULL) %>%
#     ungroup()
# 
#   new_reports_dates <- sort(unique(sched_data_new_reports$Date))
# 
#   # Remove vaccine appoints from any overlapping dates in repository and new reports
#   sched_repo <- sched_repo %>%
#     filter(!(Date >= new_reports_dates[1]))
# 
#   # Bind schedule repository and schedule from new reports
#   sched_repo <- rbind(sched_repo, sched_data_new_reports)
# 
#   # Save new repository
#   saveRDS(sched_repo, paste0(user_directory, "/R_Sched_AM_Repo/",
#                              "Auto Epic Report Sched ",
#                              format(min(sched_repo$Date), "%m%d%y"), " to ",
#                              format(max(sched_repo$Date), "%m%d%y"),
#                              " on ", format(Sys.time(), "%m%d%y %H%M"), ".rds"))
# 
# } else {
# 
# }
```

```{r Format and process new immunization data}
# new_immune_data <- unique(data)
# 
# new_immune_data <- left_join(new_immune_data,
#                              vax_admin_data_mappings,
#                              by = c("EPICDEPID" = "EpicID"))
# 
# # Add in logic to check for unmapped departments that need to be added to mapping file
# # Note: This is different than immunizations without a department listed
# 
# new_immune_data <- new_immune_data %>%
#   select(-DOSE) %>%
#   mutate(Mfg = ifelse(str_detect(IMMUNE_NAME, "PFIZER"), "Pfizer",
#                       ifelse(str_detect(IMMUNE_NAME, "MODERNA"), "Moderna",
#                              ifelse(str_detect(IMMUNE_NAME, "JOHNSON"), "J&J",
#                                     NA))),
#          VaxType = ifelse(str_detect(IMMUNE_NAME, "(\\(5-11 YEARS)\\)"),
#                           "Peds (5-11 yo)",
#                           ifelse(str_detect(IMMUNE_NAME,
#                                             "(\\(6 MONTHS - 4 YEARS\\))"),
#                                  "Peds (6 mo - 4 yo)", 
#                           "Adult (12 yo +)")),
#          Dose = ifelse(str_detect(replace_na(PRC_NAME, ""), "DOSE 1"),
#                        "Dose 1",
#                        ifelse(str_detect(replace_na(PRC_NAME, ""),
#                                          "DOSE 2"), "Dose 2",
#                               ifelse(str_detect(replace_na(PRC_NAME, ""),
#                                                 "(DOSE 3)|(BOOSTER)"),
#                                      "Dose 3/Booster", "Dose 3/Booster"
#                               ))),
#          Date = as.Date(str_extract(IMMUNE_DATE,
#                                     "[0-9]{2}\\-[A-Za-z]{3}\\-[0-9]{4}"),
#                         format = "%d-%b-%Y")
#          ) %>%
#   rename(Department = DEPARTMENT_NAME)
# 
# new_immune_data_daily_summary <- new_immune_data %>%
#   filter(!is.na(Department)) %>%
#   group_by(Date, Department, `Setting Grouper`, 
#            Site, `Hospital Roll Up`, 
#            VaxType, Dose, Mfg) %>%
#   summarize(Count = n()) %>%
#   ungroup()
# 
# # Add to existing summary
# hybrid_repo <- rbind(hybrid_repo,
#                      new_immune_data_daily_summary)

vax_admin_start_date <- min(hybrid_repo$Date)
vax_admin_end_date <- max(hybrid_repo$Date)

```

#### *Vaccines Administered from `r paste0(format(vax_admin_start_date, "%m/%d/%y"), "-", format(vax_admin_end_date, "%m/%d/%y"))`*

## {.tabset}
### All Patient Settings
```{r Create kable of all doses adminsitered to date}
# Summarize data for dashboard visualizations
summary_all_doses <- hybrid_repo %>%
  mutate(`Setting Grouper` = ifelse(str_detect(Site, "School Practice"),
                                    "MSHS Practice", `Setting Grouper`)) %>%
  group_by(`Setting Grouper`, Site, VaxType) %>%
  summarize(Count = sum(Count, na.rm = TRUE)) %>%
  arrange(`Setting Grouper`, VaxType, -Count) %>%
  pivot_wider(names_from = VaxType,
              values_from = Count) %>%
  ungroup() %>%
  arrange(`Setting Grouper`, Site) %>%
  group_split(`Setting Grouper`) %>%
  # split(.$Setting) %>%
  # relocate(Setting, .after = Site) %>%
  map_df(., function(x) {
    adorn_totals(x, where = "row",
                 name = unique(x$`Setting Grouper`),
                 fill = "MSHS Total")})

summary_all_doses <- as.data.frame(summary_all_doses)

summary_all_doses <- summary_all_doses %>%
  mutate(across(.cols = where(is.numeric),
                .fns = ~replace_na(.x, 0)))

summary_all_doses[
  which(str_detect(summary_all_doses$Site, "MSHS Total")), 2:ncol(summary_all_doses)] <- 
  lapply(summary_all_doses[
    which(str_detect(summary_all_doses$Site, "MSHS Total")), 2:ncol(summary_all_doses)], 
    function(x) {cell_spec(x, italic = TRUE, bold = TRUE)})

kable(summary_all_doses,
      format = "html",
      escape = FALSE,
      align = "l",
      digits = 0,
      caption = "MSHS Total COVID-19 Vaccine Doses Administered") %>%
  kable_styling(bootstrap_options = "hover", 
                font_size = 11,
                full_width = FALSE) %>%
  row_spec(row = 0,
           background = "#221f72",
           color = "white") %>%
  column_spec(1, bold = TRUE, italic = TRUE) %>%
  collapse_rows(columns = 1)

```

```{r Custom function for creating setting specific tables}
setting_kable <- function(setting, vax_type) {
  
  if(!(setting %in% unique(hybrid_repo$`Setting Grouper`)) |
     (!(vax_type %in% unique(hybrid_repo$VaxType)))) {
    stop(paste0("Check your setting and vaccine type."))
  }
  
  subset_data <- hybrid_repo %>%
    mutate(`Setting Grouper` = ifelse(str_detect(Site, "School Practice"),
                                    "MSHS Practice", `Setting Grouper`)) %>%
    filter(`Setting Grouper` %in% setting,
           VaxType %in% vax_type)
  
  if(nrow(subset_data) > 0) {
    
    subset_data <- subset_data %>%
      group_by(Site, Dose) %>%
      summarize(Count = n()) %>%
      pivot_wider(names_from = Dose,
                  # names_prefix = "Dose ",
                  values_from = Count) %>%
      arrange(Site) %>%
      mutate(Total = sum(across(contains("Dose")), na.rm = TRUE),
             across(.cols = where(is.numeric),
                    .fns = ~replace_na(.x, 0))) %>%
      adorn_totals(where = "row",
                   name = "MSHS Total",
                   na.rm = TRUE)
    
    kable(subset_data,
          format = "html",
          escape = FALSE,
          align = "l",
          digits = 0,
          caption = paste(setting, vax_type,
                          "Vaccine Doses Administered")) %>%
      kable_styling(bootstrap_options = "hover", 
                    font_size = 11,
                    full_width = FALSE) %>%
      row_spec(row = 0,
               background = "#221f72",
               color = "white") %>%
      row_spec(row = nrow(subset_data),
               bold = TRUE,
               italic = TRUE)
    
  }

}

```

### Hospital POD
```{r Create tables for hospital POD vaccine summary}

setting_kable(setting = "Hospital POD",
              vax_type = "Adult (12 yo +)")

setting_kable(setting = "Hospital POD",
              vax_type = "Peds (5-11 yo)")

setting_kable(setting = "Hospital POD",
              vax_type = "Peds (6 mo - 4 yo)")

```

### MSHS Practices
```{r Create tables for MSHS practice vaccine summary}

setting_kable(setting = "MSHS Practice",
              vax_type = "Adult (12 yo +)")

setting_kable(setting = "MSHS Practice",
              vax_type = "Peds (5-11 yo)")

setting_kable(setting = "MSHS Practice",
              vax_type = "Peds (6 mo - 4 yo)")

```

### MSHS Hospitals Inpatient & ED
```{r Create tables for Inpatient and ED vaccine summary}

setting_kable(setting = "MSHS Inpatient & ED",
              vax_type = "Adult (12 yo +)")

setting_kable(setting = "MSHS Inpatient & ED",
              vax_type = "Peds (5-11 yo)")

setting_kable(setting = "MSHS Inpatient & ED",
              vax_type = "Peds (6 mo - 4 yo)")

```

### Data Sources & Reference

**Data Sources**

*2020 and 2021:*
Data based on arrived visits from Epic schedule data.

*2022:*
Based on vaccines administered across health system using completed immunization orders.

*Epic Immunization Data Considerations:*

*   Immunizations with no associated Department/Epic ID excluded from analysis.
*   Vaccine type (Adult (12 yo +), Peds (5 - 11 yo), Peds (6 mo - 4 yo)) based on Immunization Name in Epic.
*   Vaccine dose based on Procedure Name field in Epic. Immunizations with ambiguous visit types are categorized as Dose 3/Booster.


***

**Department Mappings**
```{r Reference tab with data sources and mappings}
dept_mappings_dt <- dept_mappings %>%
  select(-`Hospital Roll Up`) %>%
  relocate(`Setting Grouper`) %>%
  relocate(Site, .after = `Setting Grouper`) %>%
  relocate(`Vaccine Age Group`, .after = EpicID) %>%
  rename(Setting = `Setting Grouper`,
         `Epic ID` = EpicID,
         `Vaccine Administered` = `Vaccine Age Group`) %>%
  mutate(Setting = ifelse(Setting %in% "School Based Practice",
                          "MSHS Practice", Setting),
         `Vaccine Administered` = ifelse(`Vaccine Administered` %in% "Both",
                                         "Adult & Peds",
                                         `Vaccine Administered`)) %>%
  arrange(Setting, Site, Department)

datatable(dept_mappings_dt,
          rownames = FALSE,
          options = list(
            pageLength = 20,
            paging = TRUE
          ))


```
  