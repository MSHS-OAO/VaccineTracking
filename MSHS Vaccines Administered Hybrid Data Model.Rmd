---
title: "MSHS COVID-19 Vaccination Summary"
output: html_document
---
  
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

```{r Install and load packages}
# Code for creating summary of COVID vaccine administration -----------------

#Install and load necessary packages --------------------
# install.packages("readxl")
# install.packages("writexl")
# install.packages("ggplot2")
# install.packages("lubridate")
# install.packages("dplyr")
# install.packages("reshape2")
# install.packages("svDialogs")
# install.packages("stringr")
# install.packages("formattable")
# install.packages("kableExtra")
# install.packages("ggpubr")
# install.packages("zipcodeR")
# install.packages("tidyr")

#Analysis for weekend discharge tracking
library(readxl)
library(writexl)
library(ggplot2)
library(lubridate)
library(dplyr)
library(reshape2)
library(svDialogs)
library(stringr)
library(formattable)
library(scales)
library(ggpubr)
library(reshape2)
library(knitr)
library(kableExtra)
library(rmarkdown)
library(zipcodeR)
library(tidyr)
library(purrr)
library(janitor)
library(DT)
```

```{r Set directory, import reference data, and repository, include = FALSE}
# # Determine path for working directory
# if ("Presidents" %in% list.files("J://")) {
#   user_directory <- paste0("J:/Presidents/HSPI-PM/",
#                            "Operations Analytics and Optimization/Projects/",
#                            "System Operations/COVID Vaccine")
# } else {
#   user_directory <- paste0("J:/deans/Presidents/HSPI-PM/",
#                            "Operations Analytics and Optimization/Projects/",
#                            "System Operations/COVID Vaccine")
# }

# Set path for file selection
user_path <- paste0(user_directory, "\\*.*")

# Import reference data for site and pod mappings
# Import reference data for site and pod mappings
dept_mappings <- read_excel(paste0(
  user_directory,
  "HSPI-PM/Operations Analytics and Optimization/",
  "Projects/System Operations/COVID Vaccine",
  "/Hybrid Sched & Admin Reporting",
  "/Hybrid Reporting Dept Mapping 2023-07-24.xlsx"),
  sheet = "Hybrid Dept Mapping")


vax_admin_data_mappings <- dept_mappings %>%
  select(-Department) %>%
  unique()

# Store today's date
today <- Sys.Date()

# Site order
all_sites <- c("MSB",
               "MSBI",
               "MSH",
               "MSM",
               "MSQ",
               "MSW",
               "MSVD",
               "Network")

# Vaccine types
vax_types <- c("Adult (12yo+)", "Peds (5-11yo)", "Peds (Pfizer 6mo-4yo, Moderna 6mo-6yo)")

# Dept grouper
dept_group <- c("Hospital POD", "MSHS Practice", "MSHS Inpatient & ED")
```

```{r Import existing repo and append as needed}
if (initial_run) {
  
  # Import schedule repository daily summary for 2020 and 2021
  sched_repo_summary <- readRDS(
    paste0(user_directory,
           "HSPI-PM/Operations Analytics and Optimization",
           "/Projects/System Operations/COVID Vaccine",
           "/Hybrid Sched & Admin Reporting",
           "/Hybrid Model Repo",
           "/Sched Arr Visits 2020-2021 Daily Summary 2022-09-14.RDS"))
  
  # Import vaccine administration repository daily summary for Jan-Jun 2022
  vax_admin_repo_summary <- readRDS(
    paste0(user_directory,
           "HSPI-PM/Operations Analytics and Optimization",
           "/Projects/System Operations/COVID Vaccine",
           "/Hybrid Sched & Admin Reporting",
           "/Hybrid Model Repo",
           "/Vaccine Administration Daily Summary 01012022 to 06302023 as of 2023-07-24.RDS"))
  
  hybrid_repo <- rbind(sched_repo_summary,
                       vax_admin_repo_summary)
  
  # Save new repository
  saveRDS(hybrid_repo, paste0(user_directory, 
                              "HSPI-PM/Operations Analytics and Optimization",
                              "/Projects/System Operations/COVID Vaccine",
                              "/Hybrid Sched & Admin Reporting",
                              "/Hybrid Model Repo",
                              "/Hybrid Vaccine Admin Data ",
                              format(min(hybrid_repo$Date), "%m%d%y"), " to ",
                              format(max(hybrid_repo$Date), "%m%d%y"),
                              " on ", format(Sys.time(), "%m%d%y %H%M"), ".rds"))
} else {
  
  # Select repository
  repo_file <- choose.files(
    default = 
      paste0(user_directory,
             "/Hybrid Sched & Admin Reporting",
             "/Hybrid Model Repo",
             "/*.*"),
    caption = "Select hybrid vaccine administration repository.")
  
  hybrid_repo <- readRDS(repo_file)
  
}



# Needs to be updated once we start receiving weekly reports
if (update_repo) {

  # Select most recent weekly file
  weekly_vax_admin <- choose.files(
    default = 
      paste0(user_directory,
             "/Hybrid Sched & Admin Reporting",
             "/Vaccine Admin Reports/*.*"),
    caption = "Select weekly vaccine administration data.")
  
  weekly_vax_admin <- read_excel(weekly_vax_admin)
  
  weekly_vax_admin <- unique(weekly_vax_admin)
  
  weekly_vax_admin <- left_join(weekly_vax_admin,
                                vax_admin_data_mappings,
                                by = c("EPICDEPID" = "EpicID"))
  
  unmapped_dept <- weekly_vax_admin %>%
    select(DEPARTMENT_NAME, EPICDEPID, Site) %>%
    distinct() %>%
    filter(!is.na(DEPARTMENT_NAME) & is.na(Site))
  
  if(nrow(unmapped_dept) > 0) {
    stop(paste0("Check department mappings. Missing departments include ",
                paste(as.vector(unmapped_dept$DEPARTMENT_NAME), collapse = ", "),
                "."))
  }
  
  weekly_vax_admin <- weekly_vax_admin %>%
    select(-DOSE) %>%
    mutate(VaxType = ifelse(str_detect(IMMUNE_NAME, "(\\(5-11 YEARS)\\)"),
                            "Peds (Pfizer 5-11yo)",
                            ifelse(str_detect(IMMUNE_NAME,
                                              "(\\(6 MONTHS - 4 YEARS\\))") |
                                     str_detect(IMMUNE_NAME,
                                                "COVID-19, MRNA, LNP-S, PF, PEDIATRIC 25 MCG/0.25 ML DOSE"),
                                   "Peds (Pfizer 6mo-4yo, Moderna 6mo-6yo)", 
                                   "Adult (12yo+)")),
           Mfg = ifelse(str_detect(IMMUNE_NAME, "PFIZER"), "Pfizer",
                        ifelse(str_detect(IMMUNE_NAME, "MODERNA") |
                                 str_detect(
                                   IMMUNE_NAME,
                                   "COVID-19, MRNA, LNP-S, PF, PEDIATRIC 25 MCG/0.25 ML DOSE"),
                               "Moderna",
                               ifelse(str_detect(IMMUNE_NAME, "JOHNSON"), "J&J",
                                      NA))),
           Dose = ifelse(
             str_detect(replace_na(PRC_NAME, ""), "DOSE 1"), "Dose 1",
             ifelse(
               str_detect(replace_na(PRC_NAME, ""), "DOSE 2"), "Dose 2",
               ifelse(
                 str_detect(replace_na(PRC_NAME, ""), "(DOSE 3)|(BOOSTER)"),
                 "Dose 3/Booster",
                 ifelse(
                   str_detect(replace_na(RESPONSE_LIST, ""), "First"),
                   "Dose 1",
                   ifelse(
                     str_detect(replace_na(RESPONSE_LIST, ""), "Second"),
                     "Dose 2",
                     ifelse(
                       str_detect(replace_na(RESPONSE_LIST, ""),
                                  "(Third) | (Booster)"),
                       "Dose 3/Booster",
                       ifelse(VaxType %in% "Peds (Pfizer 6mo-4yo, Moderna 6mo-6yo)",
                              "Dose 1", "Dose 3/Booster"))))))),
           Date = as.Date(IMMUNE_DATE)) %>%
    rename(Department = DEPARTMENT_NAME)
  
  weekly_admin_summary <- weekly_vax_admin %>%
    filter(!is.na(Department)) %>%
    group_by(Date, Department, `Setting Grouper`, 
             Site, `Hospital Roll Up`, 
             VaxType, Dose, Mfg) %>%  
    summarize(Count = n()) %>%
    ungroup()

  # Remove any duplicate dates, departments, etc.
  hybrid_repo <- anti_join(hybrid_repo,
                           weekly_admin_summary,
                           by = c("Date",
                                  "Department"))
  
  # Bind hybrid repository repository and most recent week's vaccine administration data
  hybrid_repo <- rbind(hybrid_repo, weekly_admin_summary)

  # Save new repository
  saveRDS(hybrid_repo, paste0(user_directory,
                              "/Hybrid Sched & Admin Reporting",
                              "/Hybrid Model Repo",
                              "/Hybrid Vaccine Admin Data ",
                              format(min(hybrid_repo$Date), "%m%d%y"), " to ",
                              format(max(hybrid_repo$Date), "%m%d%y"),
                              " on ", format(Sys.time(), "%m%d%y %H%M"), ".rds"))

}

vax_admin_start_date <- min(hybrid_repo$Date)
vax_admin_end_date <- max(hybrid_repo$Date)

```


#### *Vaccines Administered from `r paste0(format(vax_admin_start_date, "%m/%d/%y"), "-", format(vax_admin_end_date, "%m/%d/%y"))`*

## {.tabset}
### All Patient Settings
```{r Create kable of all doses adminsitered to date}
# Summarize data for dashboard visualizations
summary_all_doses <- hybrid_repo %>%
  mutate(`Setting Grouper` = ifelse(str_detect(Site, "School Practice"),
                                    "MSHS Practice", `Setting Grouper`)) %>%
  group_by(`Setting Grouper`, Site, VaxType) %>%
  summarize(Count = sum(Count, na.rm = TRUE)) %>%
  arrange(`Setting Grouper`, VaxType, -Count) %>%
  pivot_wider(names_from = VaxType,
              values_from = Count) %>%
  ungroup() %>%
  arrange(`Setting Grouper`, Site) %>%
  group_split(`Setting Grouper`) %>%
  # split(.$Setting) %>%
  # relocate(Setting, .after = Site) %>%
  map_df(., function(x) {
    adorn_totals(x, where = "row",
                 name = unique(x$`Setting Grouper`),
                 fill = "MSHS Total")})

summary_all_doses <- as.data.frame(summary_all_doses)

summary_all_doses <- summary_all_doses %>%
  mutate(across(.cols = where(is.numeric),
                .fns = ~replace_na(.x, 0)))

summary_all_doses[
  which(str_detect(summary_all_doses$Site, "MSHS Total")), 2:ncol(summary_all_doses)] <- 
  lapply(summary_all_doses[
    which(str_detect(summary_all_doses$Site, "MSHS Total")), 2:ncol(summary_all_doses)], 
    function(x) {cell_spec(x, italic = TRUE, bold = TRUE)})

kable(summary_all_doses,
      format = "html",
      escape = FALSE,
      align = "l",
      digits = 0,
      caption = "MSHS Total COVID-19 Vaccine Doses Administered") %>%
  kable_styling(bootstrap_options = "hover", 
                font_size = 11,
                full_width = FALSE) %>%
  row_spec(row = 0,
           background = "#221f72",
           color = "white") %>%
  column_spec(1, bold = TRUE, italic = TRUE) %>%
  collapse_rows(columns = 1)

```

```{r Custom function for creating setting specific tables}
setting_kable <- function(setting, vax_type) {
  
  if(!(setting %in% unique(hybrid_repo$`Setting Grouper`)) |
     (!(vax_type %in% unique(hybrid_repo$VaxType)))) {
    stop(paste0("Check your setting and vaccine type."))
  }
  
  subset_data <- hybrid_repo %>%
    mutate(`Setting Grouper` = ifelse(str_detect(Site, "School Practice"),
                                    "MSHS Practice", `Setting Grouper`)) %>%
    filter(`Setting Grouper` %in% setting,
           VaxType %in% vax_type)
  
  if(nrow(subset_data) > 0) {
    
    subset_data <- subset_data %>%
      group_by(Site, Dose) %>%
      summarize(Count = sum(Count, na.rm = TRUE)) %>%
      pivot_wider(names_from = Dose,
                  # names_prefix = "Dose ",
                  values_from = Count) %>%
      arrange(Site) %>%
      mutate(Total = sum(across(contains("Dose")), na.rm = TRUE),
             across(.cols = where(is.numeric),
                    .fns = ~replace_na(.x, 0))) %>%
      adorn_totals(where = "row",
                   name = "MSHS Total",
                   na.rm = TRUE)
    
    kable(subset_data,
          format = "html",
          escape = FALSE,
          align = "l",
          digits = 0,
          caption = paste(setting, vax_type,
                          "Vaccine Doses Administered")) %>%
      kable_styling(bootstrap_options = "hover", 
                    font_size = 11,
                    full_width = FALSE) %>%
      row_spec(row = 0,
               background = "#221f72",
               color = "white") %>%
      row_spec(row = nrow(subset_data),
               bold = TRUE,
               italic = TRUE)
    
  }

}

```

### Hospital POD
```{r Create tables for hospital POD vaccine summary}

setting_kable(setting = "Hospital POD",
              vax_type = "Adult (12yo+)")

setting_kable(setting = "Hospital POD",
              vax_type = "Peds (Pfizer 5-11yo)")

setting_kable(setting = "Hospital POD",
              vax_type = "Peds (Pfizer 6mo-4yo, Moderna 6mo-6yo)")

```

### MSHS Practices
```{r Create tables for MSHS practice vaccine summary}

setting_kable(setting = "MSHS Practice",
              vax_type = "Adult (12yo+)")

setting_kable(setting = "MSHS Practice",
              vax_type = "Peds (Pfizer 5-11yo)")

setting_kable(setting = "MSHS Practice",
              vax_type = "Peds (Pfizer 6mo-4yo, Moderna 6mo-6yo)")

```

### MSHS Hospitals Inpatient & ED
```{r Create tables for Inpatient and ED vaccine summary}

setting_kable(setting = "MSHS Inpatient & ED",
              vax_type = "Adult (12yo+)")

setting_kable(setting = "MSHS Inpatient & ED",
              vax_type = "Peds (Pfizer 5-11yo)")

setting_kable(setting = "MSHS Inpatient & ED",
              vax_type = "Peds (Pfizer 6mo-4yo, Moderna 6mo-6yo)")

```

### Data Sources & Reference

**Data Sources**

*2020 and 2021:*
Data based on arrived visits from Epic schedule data.

*2022:*
Based on vaccines administered across health system using completed immunization orders.

*Epic Immunization Data Considerations:*

*   Immunizations with no associated Department/Epic ID excluded from analysis.
*   Vaccine type (Adult (12yo+), Peds (5-11yo), Peds (Pfizer 6mo-4yo, Moderna 6mo-6yo)) based on Immunization Name in Epic.
*   Vaccine dose based on the following logic:
    1. PRC_NAME field in Epic for clearly defined visits.
    2. RESPONSE_LIST field completed during vaccination noting the dose in the series for ambiguously defined visits (ie, well visits, follow ups, etc.)
    3. If both of these are empty, the dose is assumed to be Dose 1 for Peds (Pfizer 6mo-4yo, Moderna 6mo-6yo) or Dose 3/Booster for Peds (5-11yo) and Adults (12+).


***

**Department Mappings**
```{r Reference tab with data sources and mappings}
dept_mappings_dt <- dept_mappings %>%
  select(-`Hospital Roll Up`) %>%
  relocate(`Setting Grouper`) %>%
  relocate(Site, .after = `Setting Grouper`) %>%
  relocate(`Vaccine Age Group`, .after = EpicID) %>%
  rename(Setting = `Setting Grouper`,
         `Epic ID` = EpicID,
         `Vaccine Administered` = `Vaccine Age Group`) %>%
  mutate(Setting = ifelse(Setting %in% "School Based Practice",
                          "MSHS Practice", Setting),
         `Vaccine Administered` = ifelse(`Vaccine Administered` %in% "Both",
                                         "Adult & Peds",
                                         `Vaccine Administered`)) %>%
  arrange(Setting, Site, Department)

datatable(dept_mappings_dt,
          rownames = FALSE,
          options = list(
            pageLength = 20,
            paging = TRUE
          ))


```
  